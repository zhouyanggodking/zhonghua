/*! Built with http://stenciljs.com */
const{h:t}=window.App;class e{constructor(){this.minScale=1,this.maxScale=10,this.scaleStep=.05,this.rotate=0,this.naturalImgInfo={w:0,h:0},this.resize=(()=>{this.root&&(this.orientation=this.root.offsetWidth/this.root.offsetHeight>this.naturalImgInfo.w/this.naturalImgInfo.h,this.orientation?(this.translateLimit.y=0,this.translateLimit.x=(this.root.offsetWidth-this.root.offsetHeight/this.naturalImgInfo.h*this.naturalImgInfo.w)/2):(this.translateLimit.x=0,this.translateLimit.y=(this.root.offsetHeight-this.root.offsetWidth/this.naturalImgInfo.w*this.naturalImgInfo.h)/2),this.translateXY.x=0,this.translateXY.y=0,this._scale=1,this._root.firstElementChild.firstElementChild.style.transform="",this.watchfocusAreas(this.focusAreas))}),this.lastXY={x:void 0,y:void 0},this.hold=!1,this.translateLimit={x:void 0,y:void 0},this.translateXY={x:0,y:0},this._scale=1,this.selectedX="100px",this.selectedY="200px",this.selectedWidth="200px",this.selectedHeight="200px",this.touchdistance=0,this.dragStartHandler=(t=>(this.hold=!0,t.stopPropagation&&t.stopPropagation(),t.preventDefault&&t.preventDefault(),!1)),this.dragEndHandler=(t=>(this.touch1th=null,this.touch2nd=null,this.firstCenter=null,this.touchdistance=0,this.hold=!1,this.lastXY={x:void 0,y:void 0},t.stopPropagation&&t.stopPropagation(),t.preventDefault&&t.preventDefault(),!1)),this.handleZoom=(t=>{let e;if(t.wheelDelta>0)e=this._scale+this._scale*this.scaleStep>this.maxScale?this.maxScale-this._scale:this._scale*this.scaleStep;else{if(!(t.wheelDelta<0))return;e=this._scale-this._scale*this.scaleStep<this.minScale?this.minScale-this._scale:-this._scale*this.scaleStep}let s=(this._scale+e)*((t.offsetX-this.translateXY.x)/this._scale),i=(this._scale+e)*((t.offsetY-this.translateXY.y)/this._scale);this._scale+=e;let h=t.offsetX-s,a=t.offsetY-i,o=this.calcTranslate();h>o.xa?h=o.xa:h<o.xm&&(h=o.xm),a>o.ya?a=o.ya:a<o.ym&&(a=o.ym),this.translateXY.x=h,this.translateXY.y=a,this._focusAreas=[].concat(this._focusAreas),this.layer.style.transform="translate("+h+"px,"+a+"px) scale("+this._scale+")"}),this.handleMousemove=(t=>{if(t.stopPropagation&&t.stopPropagation(),t.preventDefault&&t.preventDefault(),this.hold){let e;if(window.TouchEvent){if(!(t instanceof TouchEvent)||t instanceof TouchEvent&&1==t.touches.length)e={offsetX:t instanceof TouchEvent?t.touches[0].clientX:t.offsetX,offsetY:t instanceof TouchEvent?t.touches[0].clientY:t.offsetY},this.touch1th=null,this.touch2nd=null,this.firstCenter=null,this.touchdistance=0;else if(null==this.touch2nd)this.touch1th=t.touches[0],this.touch2nd=t.touches[1],this.firstCenter={x:(t.touches[0].clientX+t.touches[1].clientX)/2,y:(t.touches[1].clientY+t.touches[1].clientY)/2},this.touchdistance=(t.touches[0].clientX-t.touches[1].clientX)*(t.touches[0].clientX-t.touches[1].clientX)+(t.touches[1].clientY-t.touches[1].clientY)*(t.touches[1].clientY-t.touches[1].clientY);else if(null!=this.touch2nd){this.touch1th=t.touches[0],this.touch2nd=t.touches[1];let e=(t.touches[0].clientX-t.touches[1].clientX)*(t.touches[0].clientX-t.touches[1].clientX)+(t.touches[1].clientY-t.touches[1].clientY)*(t.touches[1].clientY-t.touches[1].clientY),s={wheelDelta:e-this.touchdistance,offsetX:this.firstCenter.x,offsetY:this.firstCenter.y};return this.firstCenter={x:(t.touches[0].clientX+t.touches[1].clientX)/2,y:(t.touches[1].clientY+t.touches[1].clientY)/2},this.touchdistance=e,this.handleZoom(s),!1}}else e={offsetX:t.offsetX,offsetY:t.offsetY};let s=e.offsetX-(null==this.lastXY.x?e.offsetX:this.lastXY.x),i=e.offsetY-(null==this.lastXY.y?e.offsetY:this.lastXY.y);this.translateXY.x=this.translateXY.x+s,this.translateXY.y=this.translateXY.y+i;let h=this.calcTranslate();this.translateXY.x>h.xa&&s>0?this.translateXY.x=h.xa:this.translateXY.x<h.xm&&s<0&&(this.translateXY.x=h.xm),this.translateXY.y>h.ya&&i>0?this.translateXY.y=h.ya:this.translateXY.y<h.ym&&i<0&&(this.translateXY.y=h.ym),this.layer.style.transform="translate("+this.translateXY.x+"px,"+this.translateXY.y+"px) scale("+this._scale+")",this.lastXY.x=e.offsetX,this.lastXY.y=e.offsetY}return!1})}watchrotate(){this.watchSrc(this.imgSrc)}watchSrc(t){let e=new Image,s=this._imgSrc;e.onload=(()=>{s==this._imgSrc&&this.imgSrc==t&&this.rotateImg(e.naturalWidth,e.naturalHeight,t,this.rotate).then(t=>{this._imgSrc=t.src,this.naturalImgInfo.w=t.w,this.naturalImgInfo.h=t.h,this.resize(),this.watchfocusAreas(this.focusAreas)})}),e.src=t}watchfocusAreas(t){let e=t;if(null==e?e=[]:e instanceof Array||(e=[e]),!this.naturalImgInfo||null==this.naturalImgInfo.w||null==this.naturalImgInfo.h||this.naturalImgInfo.w<=0||this.naturalImgInfo.h<=0)return void(this._focusAreas=[]);this.orientation=this.root.offsetWidth/this.root.offsetHeight>this.naturalImgInfo.w/this.naturalImgInfo.h;let s=this.orientation?this.root.offsetHeight/this.naturalImgInfo.h*this.naturalImgInfo.w:this.root.offsetWidth,i=this.orientation?this.root.offsetHeight:this.root.offsetWidth/this.naturalImgInfo.w*this.naturalImgInfo.h,h=this.orientation?this.root.offsetHeight/this.naturalImgInfo.h:this.root.offsetWidth/this.naturalImgInfo.w,a=0,o=0;this.orientation?a=(this.root.offsetWidth-s)/2:o=(this.root.offsetHeight-i)/2,this._focusAreas=[];for(let t of e)this._focusAreas.push({x:()=>t.x*h+a-(t.borderWidth?t.borderWidth:2)/this._scale+"px",y:()=>t.y*h+o-(t.borderWidth?t.borderWidth:2)/this._scale+"px",width:t.width*h+"px",height:t.height*h+"px",borderColor:t.borderColor?t.borderColor:"red",borderWidth:()=>(t.borderWidth?t.borderWidth:2)/this._scale+"px",borderType:t.borderType?t.borderType:"solid"})}calcScaleOrigin(t,e){return{x:t-this.translateXY.x*this._scale,y:e-this.translateXY.y*this._scale}}componentDidUpdate(){this.root=this._root.firstElementChild,this.layer=this._root.firstElementChild.firstElementChild}calcOffset(t,e,s){let i=[];i.push(this._calcSize(-t,0,0)),i.push(this._calcSize(-t,e,0)),i.push(this._calcSize(-t,0,s)),i.push(this._calcSize(-t,e,s));let h=0,a=0;for(let t of i)h=t.x<h?t.x:h,a=t.y<a?t.y:a;return{x:h,y:a}}calcSize(t,e,s){let i=[];i.push(this._calcSize(-t,-e/2,-s/2)),i.push(this._calcSize(-t,e/2,-s/2)),i.push(this._calcSize(-t,-e/2,s/2)),i.push(this._calcSize(-t,e/2,s/2));let h=0,a=0,o=0,r=0;for(let t of i)h=t.x<h?t.x:h,a=t.x>a?t.x:a,o=t.y<o?t.y:o,r=t.y>r?t.y:r;return{w:Math.abs(a-h),h:Math.abs(r-o)}}_calcSize(t,e,s){let i=Math.atan2(s,e)/Math.PI*180-t,h=Math.sqrt(Math.pow(s,2)+Math.pow(e,2)),a=Math.sin(i/180*Math.PI);return{x:h*Math.cos(i/180*Math.PI),y:h*a}} getDataUrlBySrc(s){}rotateImg(t,e,s,i){return null==i&&(i=0),new Promise(h=>{let a=new Image;a.setAttribute("crossOrigin",'Anonymous');a.src=s;a.onload=(()=>{let s=document.createElement("canvas"),o=s.getContext("2d"),r=this.calcSize(i,t,e),n=this.calcOffset(i,t,e);s.width=r.w,s.height=r.h,s.style.display="none";try{document.body.appendChild(s),o.translate(-n.x,-n.y),o.rotate(i*Math.PI/180),o.drawImage(a,0,0,t,e),h(Object.assign({src:s.toDataURL("image/png")},r))}finally{document.body.removeChild(s)}})})}componentDidLoad(){this.root=this._root.firstElementChild,this.layer=this._root.firstElementChild.firstElementChild,this.imgSrc&&this.watchSrc(this.imgSrc),this.root.addEventListener("mousedown",this.dragStartHandler),this.root.addEventListener("mousemove",this.handleMousemove),this.root.addEventListener("mouseup",this.dragEndHandler),this.root.addEventListener("mouseleave",this.dragEndHandler),this.root.addEventListener("touchstart",this.dragStartHandler),this.root.addEventListener("touchmove",this.handleMousemove),this.root.addEventListener("touchend",this.dragEndHandler),this.root.addEventListener("touchcancel",this.dragEndHandler),this.root.addEventListener("mousewheel",t=>(t.stopPropagation&&t.stopPropagation(),t.preventDefault&&t.preventDefault(),this.handleZoom(t),!1)),window.addEventListener("resize",this.resize)}componentDidUnload(){window.removeEventListener("resize",this.resize)}onImgLoad(){}calcTranslate(){let t,e,s,i,h=this.orientation?this.root.offsetHeight/this.naturalImgInfo.h*this.naturalImgInfo.w:this.root.offsetWidth,a=this.orientation?this.root.offsetHeight:this.root.offsetWidth/this.naturalImgInfo.w*this.naturalImgInfo.h;if(this.orientation){if(s=-(a*this._scale-this.root.offsetHeight),i=0,(t=-(this.root.offsetWidth-h)*this._scale/2)>(e=this.root.offsetWidth-((this.root.offsetWidth-h)/2+h)*this._scale)){let s=t;t=e,e=s}}else if(t=-(h*this._scale-this.root.offsetWidth),e=0,(s=-(this.root.offsetHeight-a)*this._scale/2)>(i=this.root.offsetHeight-((this.root.offsetHeight-a)/2+a)*this._scale)){let t=s;s=i,i=t}return{xm:t,xa:e,ym:s,ya:i}}dragStart(t){return t.stopPropagation(),t.preventDefault(),!1}render(){return t("div",{class:"container"},t("div",{class:"painter",style:{}},t("img",{onDragStart:this.dragStart,src:this._imgSrc,style:{height:this.orientation?"100%":"auto",width:this.orientation?"auto":"100%"}}),this._focusAreas?this._focusAreas.map(e=>t("div",{class:"selected",style:{height:e.height,width:e.width,top:e.y(),left:e.x(),border:e.borderWidth()+" "+e.borderType+" "+e.borderColor}})):void 0))}static get is(){return"encircle-image"}static get properties(){return{_focusAreas:{state:!0},_imgSrc:{state:!0},_root:{elementRef:!0},focusAreas:{type:"Any",attr:"focus-areas",watchCallbacks:["watchfocusAreas"]},imgSrc:{type:String,attr:"img-src",watchCallbacks:["watchSrc"]},maxScale:{type:Number,attr:"max-scale"},minScale:{type:Number,attr:"min-scale"},orientation:{state:!0},rotate:{type:Number,attr:"rotate",watchCallbacks:["watchrotate"]},scaleStep:{type:Number,attr:"scale-step"}}}static get style(){return"encircle-image{display:block;-webkit-box-sizing:border-box;box-sizing:border-box;contain:layout style size;overflow:hidden}encircle-image .container{height:100%;width:100%;margin:0!important;padding:0!important;border:none!important;overflow:hidden}encircle-image .painter{position:relative;overflow:hidden;pointer-events:none;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;-webkit-transform-origin:0 0;transform-origin:0 0}encircle-image .selected{position:absolute;-webkit-box-sizing:content-box;box-sizing:content-box;border:3px solid red;pointer-events:none}encircle-image img{pointer-events:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:100%}"}}export{e as EncircleImage};